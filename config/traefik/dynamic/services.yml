# Traefik Dynamic Configuration - Routers & Services
# /etc/traefik/dynamic/services.yml

http:
  routers:
    # Plex router
    plex:
      rule: "Host(`plex.freebox.tech`)"
      entryPoints:
        - websecure
      service: plex
      tls:
        certResolver: letsencrypt
      # Additional middlewares specific to Plex (on top of global ones)
      middlewares: []

    # Plex direct access (for app compatibility)
    plex-direct:
      rule: "Host(`plex.freebox.tech`) && PathPrefix(`/web`)"
      entryPoints:
        - websecure
      service: plex
      priority: 100
      tls:
        certResolver: letsencrypt

  middlewares:
    plex-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-For: ""  # Let Traefik set this automatically
          X-Real-IP: ""        # Let Traefik set this automatically

  services:
    plex:
      loadBalancer:
        servers:
          # Plex runs in the same pod, so localhost works
          - url: "https://127.0.0.1:32400"
        passHostHeader: true
        serversTransport: plex-transport
        healthCheck:
          path: /identity
          interval: 30s
          timeout: 5s

  serversTransports:
    plex-transport:
      insecureSkipVerify: true
